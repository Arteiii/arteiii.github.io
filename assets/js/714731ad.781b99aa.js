"use strict";(self.webpackChunkarteiii_github_io=self.webpackChunkarteiii_github_io||[]).push([[3059],{2242:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>s,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var r=i(4848),t=i(8453);const o={sidebar_position:4,keyword:["Kernel Mode Driver Development","Windows Driver Kit (WDK)","C++ Driver Programming","Windows Kernel Programming"],image:"./img/first_driver_preview.jpg",description:"Start pasting your first kernel driver now!",sidebar_label:"Exception Handling"},c="Exception Handling",a={id:"windows/kernel/exception_handling",title:"Exception Handling",description:"Start pasting your first kernel driver now!",source:"@site/docs/windows/kernel/exception_handling.md",sourceDirName:"windows/kernel",slug:"/windows/kernel/exception_handling",permalink:"/docs/windows/kernel/exception_handling",draft:!1,unlisted:!1,editUrl:"https://github.com/arteiii/arteiii.github.io/tree/main/docs/windows/kernel/exception_handling.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4,keyword:["Kernel Mode Driver Development","Windows Driver Kit (WDK)","C++ Driver Programming","Windows Kernel Programming"],image:"./img/first_driver_preview.jpg",description:"Start pasting your first kernel driver now!",sidebar_label:"Exception Handling"},sidebar:"docsSidebar",previous:{title:"Kernel Debugging",permalink:"/docs/windows/kernel/kernel_debugging"},next:{title:"CheatSheet",permalink:"/docs/cheatsheets/"}},s={image:i(1373).A},l=[{value:"RAII",id:"raii",level:2},{value:"Memory Allocation",id:"memory-allocation",level:3},{value:"File Handles or Device Resources",id:"file-handles-or-device-resources",level:3},{value:"Structured Exception Handling (SEH)",id:"structured-exception-handling-seh",level:2},{value:"<code>__try</code> Block",id:"__try-block",level:3},{value:"<code>__except</code> Block",id:"__except-block",level:3},{value:"Accessing Exception Information",id:"accessing-exception-information",level:3},{value:"Cleanup Code in <code>__finally</code> Block",id:"cleanup-code-in-__finally-block",level:3},{value:"Example",id:"example",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"exception-handling",children:"Exception Handling"})}),"\n",(0,r.jsx)(n.h2,{id:"raii",children:"RAII"}),"\n",(0,r.jsx)(n.p,{children:"RAII stands for Resource Acquisition Is Initialization, and it is a programming idiom in C++ where resource management is tied to object lifetime. The basic idea is that resources (like memory, file handles, network connections) are acquired during object construction and released during object destruction. This approach leverages the automatic lifetime management of C++ objects to ensure proper resource cleanup."}),"\n",(0,r.jsx)(n.p,{children:"In modern C++, RAII is commonly implemented using smart pointers, containers, and other classes to manage resources safely."}),"\n",(0,r.jsx)(n.p,{children:"When it comes to kernel drivers, RAII can be used in a similar manner for resource management. For example:"}),"\n",(0,r.jsx)(n.h3,{id:"memory-allocation",children:"Memory Allocation"}),"\n",(0,r.jsx)(n.p,{children:"You can use smart pointers like std::unique_ptr or std::shared_ptr to manage dynamically allocated memory for kernel structures. This ensures that memory is automatically deallocated when the object goes out of scope."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"\n# include <memory>\n\nclass KernelDriver {\nprivate:\n    std::unique_ptr<SomeKernelStructure> kernelData;\n\npublic:\n    KernelDriver() : kernelData(new SomeKernelStructure) {\n        // Acquire resources, initialize data, etc.\n    }\n\n    // Destructor will automatically deallocate memory\n    ~KernelDriver() {\n        // Release resources, cleanup, etc.\n    }\n};\n"})}),"\n",(0,r.jsx)(n.h3,{id:"file-handles-or-device-resources",children:"File Handles or Device Resources"}),"\n",(0,r.jsx)(n.p,{children:"RAII can be applied to manage file handles or other device-related resources by creating classes that encapsulate the resource and release it in the destructor."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:'\nclass FileHandle {\nprivate:\n    FILE* file;\n\npublic:\n    explicit FileHandle(const char* filename) : file(fopen(filename, "r")) {\n        // Handle file acquisition failure if needed\n    }\n\n    ~FileHandle() {\n        if (file) {\n            fclose(file);\n        }\n    }\n};\n'})}),"\n",(0,r.jsx)(n.p,{children:"In kernel drivers, you need to be cautious about using C++ features, as kernel-mode code often has specific constraints and may not support the full C++ standard library."}),"\n",(0,r.jsx)(n.h2,{id:"structured-exception-handling-seh",children:"Structured Exception Handling (SEH)"}),"\n",(0,r.jsx)(n.p,{children:"Structured Exception Handling (SEH) is a mechanism used to handle exceptions in a structured manner. SEH provides a way to catch and handle exceptions that occur during the execution of kernel-mode code."}),"\n",(0,r.jsx)(n.p,{children:"Here's a basic explanation of the usage of Structured Exception Handling in Windows kernel development:"}),"\n",(0,r.jsx)(n.p,{children:"Understanding Exceptions:"}),"\n",(0,r.jsx)(n.p,{children:"In kernel-mode programming, exceptions are events that disrupt the normal flow of code execution.\nExamples of exceptions include divide-by-zero, access violations, and other error conditions.\nDeclaring Exception Handlers:"}),"\n",(0,r.jsx)(n.p,{children:"Developers can use SEH to set up exception handlers to deal with specific exceptions."}),"\n",(0,r.jsxs)(n.p,{children:["In C code, an exception handler is typically declared using the ",(0,r.jsx)(n.code,{children:"__try"})," and ",(0,r.jsx)(n.code,{children:"__except"})," keywords."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:"__try {\n    // Code that might raise an exception\n}\n__except (EXCEPTION_EXECUTE_HANDLER) {\n    // Exception handling code\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"__try-block",children:[(0,r.jsx)(n.code,{children:"__try"})," Block"]}),"\n",(0,r.jsxs)(n.p,{children:["The code inside the ",(0,r.jsx)(n.code,{children:"__try"})," block is monitored for exceptions.\nIf an exception occurs within this block, control is transferred to the corresponding ",(0,r.jsx)(n.code,{children:"__except"})," block."]}),"\n",(0,r.jsxs)(n.h3,{id:"__except-block",children:[(0,r.jsx)(n.code,{children:"__except"})," Block"]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"__except"})," block contains the code to handle the exception.\nEXCEPTION_EXECUTE_HANDLER is a common constant used, indicating that the exception handler should be executed."]}),"\n",(0,r.jsx)(n.h3,{id:"accessing-exception-information",children:"Accessing Exception Information"}),"\n",(0,r.jsxs)(n.p,{children:["The GetExceptionCode and GetExceptionInformation functions can be used within the ",(0,r.jsx)(n.code,{children:"__except"})," block to obtain information about the exception."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:"\n__except (EXCEPTION_EXECUTE_HANDLER) {\n    DWORD exceptionCode = GetExceptionCode();\n    // Handle exception based on exceptionCode\n}\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"cleanup-code-in-__finally-block",children:["Cleanup Code in ",(0,r.jsx)(n.code,{children:"__finally"})," Block"]}),"\n",(0,r.jsxs)(n.p,{children:["Developers can also use a ",(0,r.jsx)(n.code,{children:"__finally"})," block to include cleanup code that will be executed whether an exception occurs or not."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:"__try {\n    // Code that might raise an exception\n}\n__finally {\n    // Cleanup code\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"example",children:"Example"}),"\n",(0,r.jsx)(n.p,{children:"Here's a simple example demonstrating the usage of SEH to handle a divide-by-zero exception:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:"__try {\n    int result = 10 / 0; // Potential divide-by-zero\n}\n__except (EXCEPTION_EXECUTE_HANDLER) {\n    // Handle divide-by-zero exception\n    // Log the exception, take appropriate action, etc.\n}\n"})})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},1373:(e,n,i)=>{i.d(n,{A:()=>r});const r=i.p+"assets/images/first_driver_preview-080caf959f5112da0ea141d08a6013b2.jpg"},8453:(e,n,i)=>{i.d(n,{R:()=>c,x:()=>a});var r=i(6540);const t={},o=r.createContext(t);function c(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:c(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);